# Git 自動化工具開發指引

這是一個 Git 工作流程自動化工具集，包含兩個核心 Bash 腳本和 AI 驅動的內容產生系統。

## 🏗️ 架構概覽

### 雙腳本架構
- **`git-auto-push.sh`** (2397 行) - 傳統 Git 操作自動化（add/commit/push）
- **`git-auto-pr.sh`** (2619 行) - GitHub Flow PR 流程自動化
- **`install.sh`** (532 行) - POSIX Shell 相容安裝腳本

### 核心設計模式
- **模組化函數設計**：所有主要功能都封裝為獨立函數（如 `error_msg()`, `run_command()`）
- **AI 工具容錯鏈**：支援多個 AI CLI 工具 (`codex` → `gemini` → `claude`) 的自動容錯機制
- **配置驅動**：所有可配置項集中在檔案頂部（AI 工具順序、分支設定等）

## ⚙️ 關鍵配置系統

### AI 工具配置 (兩檔案同步)
```bash
# 位置：檔案頂部預設值區域，使用條件賦值
# 配置文件優先載入，若未設定則使用預設值
if [ ${#AI_TOOLS[@]} -eq 0 ]; then
    AI_TOOLS=("gemini" "codex" "claude")  # 預設優先順序
fi
```

### 外部配置文件
```bash
# 配置文件位置（優先級順序）
# 1. $PWD/.git-auto-push-config/.env  （專案級）
# 2. $HOME/.git-auto-push-config/.env （用戶級）
# 3. [script_dir]/.git-auto-push-config/.env （全域）
```

### 調試模式配置
```bash
# 位置：檔案頂部配置區域
IS_DEBUG=false  # 一般使用（預設）
IS_DEBUG=true   # 開發調試時開啟
```
> ⚠️ **注意**：調試訊息可能包含敏感資訊（如 API 回應、diff 內容），啟用後會大幅增加輸出內容，建議僅在開發調試時開啟。

### 分支管理配置 (git-auto-pr.sh 獨有)
```bash
# 使用條件賦值，配置文件優先
DEFAULT_MAIN_BRANCHES=("uat" "main" "master")  # 自動偵測順序
DEFAULT_USERNAME="jerry"                        # 預設使用者名稱  
AUTO_DELETE_BRANCH_AFTER_MERGE=false            # PR 合併後分支處理策略
```

## 🔧 開發工作流程

### 修改 AI 行為
1. **提示詞調整**：修改檔案頂部的 `generate_ai_*_prompt()` 函數
2. **工具順序**：調整 `AI_TOOLS` 陣列元素順序
3. **容錯邏輯**：在對應的 `run_*_command()` 函數中添加錯誤處理

### 錯誤處理模式
- **自動偵測**：`401 Unauthorized`, `token_expired`, `stream error` 等特定錯誤
- **具體建議**：每種錯誤都提供對應的修復命令（如 `gh auth login`）
- **優雅降級**：AI 工具全部失效時自動切換至手動輸入模式

### 分支管理最佳實踐
- **主分支保護**：絕對禁止刪除 `DEFAULT_MAIN_BRANCHES` 中定義的分支
- **分支命名規則**：`{username}/{type}/{issue-key}` 格式，自動小寫轉換
- **安全確認機制**：多重確認防止誤刪未合併分支

## 🎯 核心函數架構

### 通用工具函數
- **訊息輸出**：`error_msg()`, `success_msg()`, `warning_msg()` - 彩色格式化輸出
- **指令執行**：`run_command()` - 統一的指令執行介面
- **Loading 動畫**：`show_loading()` - 長時間操作的使用者體驗

### AI 整合函數
- **AI 指令執行**：`run_codex_command()`, `run_stdin_ai_command()` - 各種 AI 工具的統一介面
- **輸出清理**：`clean_ai_message()` - 過濾 AI 工具的技術雜訊
- **容錯機制**：45 秒超時，自動切換至下一個 AI 工具

### Git 操作函數
- **狀態檢查**：`check_git_repository()`, `get_git_status()` - Git 倉庫驗證
- **檔案處理**：`add_all_files()` - Git add 操作封裝
- **分支管理**：主分支自動偵測和分支安全刪除邏輯

## 🚨 開發注意事項

### 同步修改要求
修改 AI 相關功能時，必須同時更新兩個檔案：
- `git-auto-push.sh` - AI commit 訊息產生
- `git-auto-pr.sh` - AI PR 內容和分支名稱產生

### 安全考量
- **權限檢查**：腳本不需要 root 權限，但會執行 Git 和網路操作
- **資料保護**：所有使用者輸入都會經過清理和驗證
- **中斷處理**：支援 Ctrl+C 優雅退出，自動清理暫存資源

### 測試策略
```bash
# 語法檢查
bash -n git-auto-push.sh && bash -n git-auto-pr.sh

# 基本功能測試
./git-auto-push.sh --help
./git-auto-pr.sh --help

# AI 工具連線測試
for tool in codex gemini claude; do command -v "$tool" && echo "$tool 可用"; done
```

## 🔄 版本管理慣例

### 行數統計維護
README.md 中包含精確的行數統計，修改後需同步更新：
- `git-auto-push.sh`: 當前 2397 行
- `git-auto-pr.sh`: 當前 2619 行
- `install.sh`: 當前 532 行

### Commit 訊息規範
遵循 [Conventional Commits](https://www.conventionalcommits.org/) 格式，工具本身也會產生符合此規範的 commit 訊息。

### 功能標註
新功能使用 🆕 標註，改進使用 🔧 標註，保持 README.md 的一致性。

---

## 📋 文檔撰寫規範

### README.md 撰寫規則

#### 🎯 內容原則
- **簡潔性原則**：README 應為專案概覽，避免過度詳細的版本歷史
- **引導性原則**：重點在於快速上手和核心功能介紹
- **可讀性原則**：結構清晰，使用標題、表格、程式碼區塊等格式化元素

#### 📝 結構規範

**必要章節（依序）**：
1. **專案簡介** - 一句話概述 + 主要功能亮點
2. **系統架構** - 核心元件和專案結構
3. **安裝與啟動** - 快速開始指南
4. **使用方法** - 基本操作和常見場景
5. **使用情境** - 實際應用範例
6. **特色功能** - 核心亮點功能詳述
7. **錯誤排除** - 常見問題和解決方案
8. **進階使用** - 高級功能和最佳實踐
9. **開發修改注意事項** - 程式碼架構和修改指導
10. **📋 更新日誌** - 簡化版本資訊
11. **參考資源** - 相關文件連結
12. **截圖展示** - 視覺化展示
13. **授權條款** - 法律聲明

#### ⚠️ 版本資訊限制

**允許在 README 中的版本資訊**：
- ✅ 最新版本號和發布日期
- ✅ 總版本數統計
- ✅ 開發期間時間跨度
- ✅ 程式碼行數統計

**禁止在 README 中的版本資訊**：
- ❌ 詳細的功能變更描述
- ❌ 具體的程式碼修改說明
- ❌ 版本間的完整對比
- ❌ 超過 3 個版本的歷史記錄

**正確的版本資訊格式**：
```markdown
## 📋 更新日誌

> 📋 **完整版本歷史**：查看 [CHANGELOG.md](CHANGELOG.md) 瞭解所有版本更新記錄和詳細功能說明

- 📅 **最新版本**：v2.5.0 (2025-11-09)
- 📈 **總版本數**：13 個主要版本  
- 🗓️ **開發期間**：2025-09-13 至今
- 📊 **程式碼行數**：`git-auto-push.sh` 3,065 行、`git-auto-pr.sh` 3,135 行
```

### CHANGELOG.md 撰寫規則

#### 🎯 內容原則
- **完整性原則**：記錄所有版本的詳細變更
- **結構化原則**：使用標準化的格式和分類
- **可追蹤原則**：每個變更都應有明確的分類和描述

#### 📝 格式規範

**檔案結構**：
```markdown
# 專案名稱 - 更新日誌

> 專案簡述

## 版本歷史

### vX.X.X - 版本名稱 (YYYY-MM-DD)

**🆕 新功能**
**🔧 改進**  
**🐛 修復**
**📊 行數統計更新**
**🎯 使用場景**
**⚙️ 配置方式**

---

## 版本統計
## 相關文檔
```

#### 🏷️ 變更分類標準

**🆕 新功能**：全新的功能特性
- 新增的 API 或指令選項
- 全新的工作流程或模式
- 新的整合功能

**🔧 改進**：對現有功能的優化
- 效能提升
- 使用者體驗改善
- 程式碼重構

**🐛 修復**：錯誤修正
- Bug 修復
- 相容性問題解決
- 安全性修復

**📊 統計更新**：必須包含精確的行數變化
- 格式：`檔名：舊行數 → 新行數（+/-變化量）`

#### 📅 版本命名規範

**格式**：`vX.Y.Z - 功能名稱 (YYYY-MM-DD)`
- **主版本 (X)**：重大架構變更或不相容更新
- **次版本 (Y)**：新功能或重要改進
- **修訂版本 (Z)**：錯誤修復和小幅改進

**範例**：
- `v2.5.0 - 程式碼重構與專案清理 (2025-11-09)`
- `v2.4.1 - 檔案過濾功能修復 (2025-11-08)`

#### ⚡ 撰寫最佳實踐

**詳細程度**：
- ✅ 具體描述功能的作用和效益
- ✅ 包含配置範例和使用場景
- ✅ 提供升級或遷移指導
- ❌ 避免過於技術性的實作細節

**使用者導向**：
- 優先描述對使用者的影響和好處
- 提供實際的使用範例
- 標註重要的相容性變更

**可追蹤性**：
- 每個變更都應該有對應的 commit 或 PR 參考
- 重要功能變更應該有對應的文檔連結
- 行數統計應該精確且可驗證

### 🔄 文檔同步維護

#### 版本發布時的文檔更新流程

1. **更新 CHANGELOG.md**：
   - 新增最新版本的詳細記錄
   - 更新版本統計資訊
   - 確認所有變更都有適當分類

2. **更新 README.md**：
   - 僅更新版本號和發布日期
   - 更新程式碼行數統計
   - 確認 CHANGELOG 連結正確

3. **驗證一致性**：
   - 確認兩個文件中的版本號一致
   - 驗證行數統計的準確性
   - 檢查所有連結的有效性

#### 📋 文檔品質檢核清單

**README.md 檢核**：
- [ ] 專案簡介清晰簡潔（1-2 句）
- [ ] 安裝步驟完整且可操作
- [ ] 使用範例實用且正確
- [ ] 版本資訊僅包含摘要統計
- [ ] 所有連結可正常訪問
- [ ] 結構符合標準章節順序

**CHANGELOG.md 檢核**：
- [ ] 版本按時間倒序排列（最新在上）
- [ ] 每個版本都有發布日期
- [ ] 變更分類使用標準 emoji 和標籤
- [ ] 行數統計精確且已驗證
- [ ] 重要變更有使用範例
- [ ] 格式符合 Keep a Changelog 規範

---

開發時優先參考現有函數的實作模式，保持程式碼風格一致性，並確保所有修改都經過基本的功能測試。文檔更新應該與程式碼變更同步進行，確保使用者能夠獲得準確且最新的資訊。