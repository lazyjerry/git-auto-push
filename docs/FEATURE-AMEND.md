# 變更最後一次 Commit 訊息功能

## 功能概述

新增**選項 7：🔄 變更最後一次 commit 訊息**，讓使用者可以安全地修改最近一次提交的訊息內容。

## 核心功能

### 1. 智慧安全檢查
```bash
# 自動偵測尚未提交的變更
⚠️  偵測到尚未提交的變更！
請先提交或暫存 (stash) 目前的變更，再修改最後一次 commit 訊息。
```

如果工作區有未提交的變更，功能會：
- 🛡️ **阻止操作** - 避免意外包含新變更
- 📋 **列出變更** - 顯示所有未提交的檔案
- 💡 **提供建議** - 提示使用 commit 或 stash

### 2. 參考原訊息顯示
```bash
==================================================
📝 目前的 commit 訊息：
「[feat-001] 原始測試訊息」
==================================================
```

在輸入新訊息前，清楚顯示目前的內容供參考。

### 3. 任務編號自動帶入

#### 自動模式 (AUTO_INCLUDE_TICKET=true)
```bash
💬 請輸入新的 commit 訊息
==================================================
🎫 任務編號: feat-001 (將自動加入前綴)

➤ 修改後的訊息內容

# 自動產生 ↓
[feat-001] 修改後的訊息內容
```

#### 詢問模式 (AUTO_INCLUDE_TICKET=false)
```bash
💬 請輸入新的 commit 訊息
==================================================
🎫 任務編號: feat-001 (稍後詢問是否加入)

➤ 修改後的訊息內容

🎫 偵測到任務編號: feat-001
是否在 commit 訊息中加入任務編號前綴？[Y/n]: y

# 產生結果 ↓
[feat-001] 修改後的訊息內容
```

### 4. 二次確認機制
```bash
==================================================
🔄 將要修改為：
「[feat-001] 修改後的測試訊息」
==================================================
是否確認提交？[Y/n]: 
```

在實際執行 `git commit --amend` 前，會顯示完整的新訊息並要求確認。

### 5. 執行結果反饋
```bash
正在修改最後一次 commit 訊息...
✅ Commit 訊息修改成功！

修改後的訊息：
「[feat-001] 修改後的測試訊息」
```

## 使用場景

### 情境一：有未提交變更時
```bash
$ ./git-auto-push.sh
# 選擇 7

⚠️  偵測到尚未提交的變更！
請先提交或暫存 (stash) 目前的變更，再修改最後一次 commit 訊息。

未提交的變更：
M  git-auto-push.sh
```
**建議操作**：先 `git add` + `git commit` 或 `git stash`

### 情境二：乾淨工作區且有變更待暫存
```bash
$ ./git-auto-push.sh

檢測到以下變更:
M  README.md

# 正常流程，會先 add 檔案然後顯示完整選單
選擇 7 即可修改最後一次 commit
```

### 情境三：完全乾淨的工作區
```bash
$ ./git-auto-push.sh

沒有需要提交的變更。
您可以選擇：
  • 推送本地提交到遠端 (按 p)
  • 修改最後一次 commit 訊息 (按 7)  ← 快速選項
  • 查看倉庫資訊 (按 6)
  • 或按其他鍵取消

請選擇操作 [p/7/6/取消]: 7
```

## 技術實作

### 核心函數：amend_last_commit()

```bash
amend_last_commit() {
    # 1. 檢查未提交變更 (git status --porcelain)
    # 2. 取得最後 commit 訊息 (git log -1 --pretty=%B)
    # 3. 顯示目前訊息供參考
    # 4. 輸入新訊息
    # 5. 處理任務編號 (呼叫 append_ticket_number_to_message)
    # 6. 二次確認
    # 7. 執行 git commit --amend -m "..."
}
```

### 整合點

1. **選單系統** (`show_operation_menu`)
   - 新增第 7 個選項：🔄 變更最後一次 commit 訊息

2. **選擇處理** (`get_operation_choice`)
   - 接受 `7` 作為有效輸入
   - 更新範圍提示為 `[1-7]`

3. **主程式流程** (`main`)
   - Case 7: 呼叫 `amend_last_commit()`
   - 無變更時提供快捷選項

4. **說明文件** (`show_help`)
   - 新增「7️⃣ 變更最後一次 commit 訊息」完整說明

5. **顏色輸出** (`yellow_msg`)
   - 新增黃色訊息函數用於重要提示

## 注意事項

### ⚠️ 重要警告

```
⚠️  注意：請勿修改已推送至遠端的 commit
```

**原因**：
- 修改已推送的 commit 會改變 Git 歷史
- 若其他人已經 pull 該 commit，會導致版本衝突
- 需要使用 `git push --force` 強制推送（不建議）

**建議做法**：
- ✅ 僅修改尚未推送的本地 commit
- ✅ 如果已推送，考慮建立新的修正 commit
- ❌ 避免在團隊協作分支上使用 amend

## 測試驗證

### 功能測試檢查清單

- [x] 有未提交變更時正確警告並中止
- [x] 顯示目前 commit 訊息供參考
- [x] 支援任務編號自動帶入 (AUTO_INCLUDE_TICKET=true)
- [x] 支援任務編號詢問模式 (AUTO_INCLUDE_TICKET=false)
- [x] 二次確認機制運作正常
- [x] 成功執行 git commit --amend
- [x] 顯示修改後的最終訊息
- [x] 無變更時提供快速選項 (p/7/6)
- [x] 語法檢查通過 (bash -n)

## 使用範例

### 範例一：修正錯字

**原訊息**：`[feat-001] 新增使用這介面`  
**操作流程**：
1. 執行 `./git-auto-push.sh`
2. 選擇 `7`
3. 輸入：`新增使用者介面`
4. 確認：`y`

**結果**：`[feat-001] 新增使用者介面`

### 範例二：補充說明

**原訊息**：`[bug-456] 修復登入問題`  
**新訊息**：`修復登入問題 - 修正 session timeout 處理邏輯`

**最終結果**：`[bug-456] 修復登入問題 - 修正 session timeout 處理邏輯`

### 範例三：取消操作

```bash
💬 請輸入新的 commit 訊息
➤ 

未輸入新的 commit 訊息，操作已取消。
```

空白輸入會自動取消操作，保持原 commit 不變。

## 未來改進方向

1. **互動式編輯器**：整合 `git commit --amend` 的編輯器模式
2. **歷史瀏覽**：支援查看最近 N 次 commit 並選擇要修改的
3. **批次修改**：支援 `git rebase -i` 進行多次 commit 的修改
4. **安全檢查增強**：偵測 commit 是否已推送至遠端
5. **Undo 功能**：提供 reflog 快速復原機制

## 相關資源

- Git 官方文件：[git-commit --amend](https://git-scm.com/docs/git-commit#Documentation/git-commit.txt---amend)
- 主腳本：`git-auto-push.sh`
- 相關函數：`append_ticket_number_to_message()`, `confirm_commit()`
- 配置項目：`AUTO_INCLUDE_TICKET` (預設 `true`)

---

**版本**：v2.1.0  
**新增日期**：2025-11-02  
**維護者**：Jerry  
